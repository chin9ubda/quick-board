name: Deploy to server (central)
on:
  push:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      project:
        description: 'project to deploy (quick-board or antibudget)'
        required: false
        default: 'quick-board'

jobs:
  deploy:
    runs-on: self-hosted
    env:
      SERVER_PROJECT_DIR: /data/dev
    steps:
      - uses: actions/checkout@v4
      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_PAT }}
      - name: Pull images and deploy
        run: |
          set -euo pipefail
          PROJECT=${{ github.event.inputs.project || 'quick-board' }}
          echo "Deploying $PROJECT"
          # pull frontend/backend images for quick-board (pattern)
          if [ "$PROJECT" = "quick-board" ]; then
            docker pull ghcr.io/${{ github.repository_owner }}/quick-board-frontend:latest || true
            docker pull ghcr.io/${{ github.repository_owner }}/quick-board-backend:latest || true
            cd /data/dev/$PROJECT/services/frontend && docker compose pull || true
            cd /data/dev/$PROJECT/services/frontend && docker compose up -d || true
            cd /data/dev/$PROJECT/services/backend && docker compose pull || true
            cd /data/dev/$PROJECT/services/backend && docker compose up -d || true
          elif [ "$PROJECT" = "antibudget" ]; then
            # antibudget images are local, ensure compose up
            cd /data/dev/$PROJECT/services/frontend && docker compose pull || true
            cd /data/dev/$PROJECT/services/frontend && docker compose up -d || true
            cd /data/dev/$PROJECT/services/backend && docker compose pull || true
            cd /data/dev/$PROJECT/services/backend && docker compose up -d || true
          fi
          # reload central nginx (no config change expected)
          cd /data/dev/nginx && docker compose up -d
